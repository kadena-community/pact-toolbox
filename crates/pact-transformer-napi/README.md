# Pact Transformer Native

A high-performance Pact code transformer using tree-sitter with NAPI-RS bindings for Node.js.

## Overview

This native module provides lightning-fast parsing and transformation of Pact smart contract code into JavaScript/TypeScript, leveraging the power of Rust and tree-sitter for optimal performance.

## Features

- üöÄ **High Performance**: Built with Rust for maximum speed
- üå≤ **Tree-sitter Parsing**: Uses the official tree-sitter-pact grammar
- üìù **TypeScript Support**: Generates TypeScript definitions automatically
- üîß **Easy Integration**: Simple Node.js API
- üéØ **Zero Dependencies**: Self-contained native module

## Installation

```bash
npm install @pact-toolbox/transformer-native
```

## Quick Start

### Transform Pact Code

```javascript
import { PactTransformer, transformPactCode } from "@pact-toolbox/transformer-native";

const pactCode = `
(namespace 'coin)

(module coin GOVERNANCE
  "A simple coin contract"

  (defschema account
    "User account schema"
    balance:decimal)

  (defun transfer:bool (from:string to:string amount:decimal)
    "Transfer coins between accounts"
    (with-capability (TRANSFER from to amount)
      (transfer-create from to amount)))
)
`;

// Using the standalone function
const result = transformPactCode(pactCode, { debug: true });
console.log("Generated JavaScript:", result.code);
console.log("Generated TypeScript:", result.types);
console.log("Parsed modules:", result.modules);

// Using the class instance
const transformer = new PactTransformer();
const modules = transformer.parse(pactCode);
const transformResult = transformer.transform(pactCode, { debug: false });
```

### Generated Output

The transformer generates clean JavaScript and TypeScript code:

**JavaScript (`result.code`):**

```javascript
// This file was generated by the Pact Toolbox
import { execution } from "@pact-toolbox/client";

export function transfer(from, to, amount) {
  return execution(`(coin.transfer ${JSON.stringify(from)} ${JSON.stringify(to)} ${JSON.stringify(amount)})`);
}
```

**TypeScript (`result.types`):**

```typescript
// This file was generated by the Pact Toolbox
import { PactTransactionBuilder, PactExecPayload } from "@pact-toolbox/client";

/**
 * User account schema
 */
export interface Account {
  balance: number;
}

/**
 * Transfer coins between accounts
 */
export function transfer(from: string, to: string, amount: number): PactTransactionBuilder<PactExecPayload, boolean>;
```

## API Reference

### `PactTransformer`

Main transformer class for parsing and transforming Pact code.

#### Constructor

```javascript
const transformer = new PactTransformer();
```

#### Methods

##### `parse(pactCode: string): PactModule[]`

Parses Pact code and returns the AST structure without code generation.

```javascript
const modules = transformer.parse(pactCode);
```

##### `transform(pactCode: string, options?: TransformOptions): TransformationResult`

Transforms Pact code into JavaScript/TypeScript code and type definitions.

```javascript
const result = transformer.transform(pactCode, { debug: true });
```

### Standalone Functions

##### `transformPactCode(pactCode: string, options?: TransformOptions): TransformationResult`

Transform Pact code in a single function call.

```javascript
const result = transformPactCode(pactCode, { debug: false });
```

##### `parsePactCode(pactCode: string): PactModule[]`

Parse Pact code in a single function call.

```javascript
const modules = parsePactCode(pactCode);
```

### Types

#### `TransformOptions`

```typescript
interface TransformOptions {
  debug?: boolean; // Enable debug logging in generated code
}
```

#### `TransformationResult`

```typescript
interface TransformationResult {
  modules: PactModuleInfo[];
  code: string; // Generated JavaScript code
  types: string; // Generated TypeScript definitions
}
```

#### `PactModule`

```typescript
interface PactModule {
  name: string;
  path: string;
  namespace?: string;
  governance?: string;
  doc?: string;
  functions: PactFunction[];
  schemas: PactSchema[];
  capabilities: PactCapability[];
}
```

#### `PactFunction`

```typescript
interface PactFunction {
  name: string;
  path: string;
  doc?: string;
  parameters: PactParameter[];
  returnType: string;
  requiredCapabilities: string[];
}
```

#### `PactSchema`

```typescript
interface PactSchema {
  name: string;
  doc?: string;
  fields: PactSchemaField[];
}
```

## Performance

This native module provides significant performance improvements over pure JavaScript implementations:

- **Parsing Speed**: 10-50x faster than JS-based parsers
- **Memory Usage**: Lower memory footprint
- **CPU Efficiency**: Optimized Rust implementation

## Building from Source

### Prerequisites

- Rust 1.85.0 or later
- Node.js 16 or later
- `@napi-rs/cli` globally installed

### Build Steps

```bash
# Install dependencies
npm install

# Build the native module
npm run build

# Run tests
npm test

# Build for all supported platforms
npm run build:release
```

### Supported Platforms

- Linux x64 (GNU/MUSL)
- macOS x64/ARM64
- Windows x64
- And more...

## Error Handling

The transformer provides detailed error information for invalid Pact code:

```javascript
try {
  const result = transformPactCode(invalidPactCode);
} catch (error) {
  console.error("Parse error:", error.message);
  // Error includes line/column information for debugging
}
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## License

MIT License - see LICENSE file for details.

## Related Projects

- [Pact Language](https://pact-language.readthedocs.io/)
- [Tree-sitter Pact](https://github.com/kadena-community/tree-sitter-pact)
- [Pact Toolbox](https://github.com/kadena-community/pact-toolbox)
